const fetch = (...args) => import('node-fetch').then(({ default: fetch }) => fetch(...args));
const config = require('../config.json');
const UbfbError = require('./UbfbError');

fetch.fetchs = 0;

fetch.get = async (route) => {
    fetch.fetchs++;

    let got = await (await fetch(`${config.domain}/api/${config.apiVersion}/${route}/`, {
        headers: {
            'Content-Type': 'application/json',
            'Authorization': module.exports.token ?? 0
        }
    })).json().catch(err => {
        return UbfbError('Petición a UBFB fallida: ' + err);
    });

    return got;
};

fetch.post = async (route, body) => {
    fetch.fetchs++;

    let got = await (await fetch(`${config.domain}/api/${config.apiVersion}/${route}/`, {
        method: 'post',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': module.exports.token ?? 0 
        },
        body: typeof body === 'string' && JSON.parse(body)? body : JSON.stringify(body)
    })).json().catch(err => {
        return UbfbError('Petición a UBFB fallida: ' + err);
    });

    return got;
};

module.exports = fetch;